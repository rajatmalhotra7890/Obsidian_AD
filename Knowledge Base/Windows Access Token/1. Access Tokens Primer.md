### What is token impersonation?
- Token impersonation is a way of impersonating a user's access token, allowing you to effectively take over the user without needing to know the user's password.
- Subsequently, attackers are currently using this in the wild to escalate privielges and move laterally across the network.
	- However, without proper mitigation, its relatively easier to perform.

The one twist is that token impersonation is that it is a post-exploitation attack.
- This means we already need to have a shell on the device, with local admin privileges to perform this attack.


### What is an access token?
- An access token is an object that describes the `security context` of a process or a thread.
- The information in the access token includes the identity and privileges of the user's account associated with the process or thread.
- When a user logs on to a computer, the system verifies the user's password by comparing it with the information stored in a security database.
	- If the password is authenticated with LSASS/LSA, the system produces an access token.
	- Every process executed on behalf of this user has a copy of his access token.
- Access tokens are generated by the `winlogon` process when user logins successfully.

An access token stores the following information:
1. User's SID
2. A logon SID which identifies the current logon session
3. Owner SID
4. Users and Groups privileges
5. SID for primary group
6. A flag indicating if the token is a primary or impersonation token
7. SID of groups that the user belonged to user when the user was authenticated.

##### Now the above access token is attached to the `userinit.exe` process after which all child processes started by the user will inherit the copy of access from the creator and the process will run with the same privilege of the user whose access token is used to create the new process and the process will inherit the copy of the access token which identifies the logged on user and used to separate processes in terms of their privileges.


## Objective of the Token impersonation attack
- To find an access token that belongs to a privileged account on the system and inherit/impersonate it, you essentially obtain privileges as that access token


[More on Access tokens](https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e)


# Types of Access Tokens
1. Primary Tokens
2. Impersonation Tokens


### 1. Primary Tokens
- Primary tokens are used to present default security information for a process or a thread
- Describes security context of user account associated with the process

**Primary** tokens get created when a user logs on to a Windows Domain. This can be physically sitting in front of a windows box or remotely via Remote Desktop.


### 2. Impersonation Tokens
- Impersonation tokens allows for a thread to perform an operation using an access token from another user or client.
- Impersonation tokens are typically used in client/server communication.

**Impersonation** tokens typically, run something in a different security context to the process that started it. These non-interactive tokens are used for mounting network shares or domain logon scripts.

For example, when a user accesses SMB file share, server needs a copy of user's token to validate that the user has sufficient permissions.
- The exeucting server side thread includes an impersonation token along with the thread's primary token, and uses impersonation token to perform access checks for user's actions.


![[Pasted image 20221030213807.png]]


